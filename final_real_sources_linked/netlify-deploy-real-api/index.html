<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>NOVA Finance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/index-DkxZYwTq.css" />
  <link rel="modulepreload" href="./assets/index-B4pZZ_yq.js" />
  <style>
    /* 簡易健康檢查列樣式，不影響你的 SPA */
    #healthbar { font: 12px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; 
      background:#0b1020; color:#cbd5e1; padding:8px 10px; display:flex; gap:12px; align-items:center }
    #healthbar .ok { color:#22c55e } #healthbar .warn{ color:#eab308 } #healthbar .err{ color:#ef4444 }
    #healthbar code { background:#111827; padding:2px 4px; border-radius:4px }
  </style>
</head>
<body>
  <!-- 健康檢查列（部署後可保留，也可刪） -->
  <div id="healthbar">啟動檢查中…</div>

  <div id="root"></div>

  <!-- （可有可無）若你有 config.js -->
  <script defer src="./config.js"></script>

  <!-- 安全 fetch 包裝器：確保前端拿到的是「可渲染」的形狀 -->
  <script>
  (function () {
    const ORIG_FETCH = window.fetch.bind(window);

    // 你打包前端原本抓的路徑 → 以 redirects 對應到 functions。
    // 這裡另外指定在非 data/*.json 時也可直打 functions。
    const MAP = {
      'data/taiwan-keywords.json': '/.netlify/functions/stock-trends',
      'data/industry-news.json': '/.netlify/functions/news?mode=industry',
      'data/us-economic-news.json': '/.netlify/functions/news?mode=us_economic',
      'data/us-indices.json': '/.netlify/functions/usindices'
    };

    // 對不同資源給「安全預設形狀」
    function defaultShape(url) {
      if (url.includes('us-indices')) return { indices: [] };
      if (url.includes('industry-news') || url.includes('us-economic-news')) return { items: [] };
      if (url.includes('taiwan-keywords')) return { keywords: [] };
      return {};
    }

    // 把 function 回來的 JSON 轉成「前端老程式期望的扁平形狀」
    function flattenForLegacy(url, obj) {
      if (url.includes('us-indices')) {
        if (Array.isArray(obj?.indices)) return obj.indices;
        if (Array.isArray(obj?.data?.indices)) return obj.data.indices;
        return [];
      }
      if (url.includes('industry-news') || url.includes('us-economic-news')) {
        if (Array.isArray(obj?.items)) return obj.items;
        if (Array.isArray(obj?.data?.items)) return obj.data.items;
        return [];
      }
      if (url.includes('taiwan-keywords')) {
        if (Array.isArray(obj?.keywords)) return obj.keywords;
        if (Array.isArray(obj?.data?.keywords)) return obj.data.keywords;
        return [];
      }
      return obj;
    }

    window.fetch = async function (input, init) {
      const reqUrl = typeof input === 'string' ? input : (input && input.url) || '';
      const key = Object.keys(MAP).find(k => reqUrl.includes(k));
      const finalUrl = key ? MAP[key] : reqUrl;

      try {
        const res = await ORIG_FETCH(finalUrl, init);
        const ct = (res.headers.get('content-type') || '').toLowerCase();

        // 嘗試解析 JSON；不是 JSON 就用文字包成 note
        let data;
        if (ct.includes('application/json')) {
          data = await res.json();
        } else {
          const text = await res.text();
          data = { note: text };
        }

        // 將 {ok:false} 或自定結構，轉成前端可用扁平形狀
        const flattened = flattenForLegacy(reqUrl, data);
        const safe = flattened ?? flattenForLegacy(reqUrl, defaultShape(reqUrl));

        return new Response(JSON.stringify(safe), {
          status: 200,
          headers: { 'content-type': 'application/json' }
        });
      } catch (e) {
        console.error('[fetch guard]', finalUrl, e);
        const safe = flattenForLegacy(reqUrl, defaultShape(reqUrl));
        return new Response(JSON.stringify(safe), {
          status: 200,
          headers: { 'content-type': 'application/json' }
        });
      }
    };

    // 頁面級護欄（避免未捕捉例外讓整頁白）
    window.addEventListener('error', e =>
      console.error('[GlobalError]', e?.error || e?.message || e));
    window.addEventListener('unhandledrejection', e =>
      console.error('[PromiseRejection]', e?.reason || e));

    console.log('[OK] safe fetch installed');
  })();
  </script>

  <!-- 載入你的 Vite 主腳本（記得是 type="module"） -->
  <script type="module" crossorigin src="./assets/index-B4pZZ_yq.js"></script>

  <!-- 啟動後的健康檢查（把結果顯示在頁面上，方便你肉眼確認） -->
  <script>
  (async function health() {
    const el = document.getElementById('healthbar');
    const tests = [
      ['indices', '/.netlify/functions/usindices'],
      ['news_industry', '/.netlify/functions/news?mode=industry'],
      ['trends', '/.netlify/functions/stock-trends']
    ];

    const results = [];
    for (const [name, url] of tests) {
      try {
        const r = await fetch(url);
        const ct = (r.headers.get('content-type') || '').toLowerCase();
        let ok = ct.includes('application/json');
        if (ok) {
          const j = await r.json().catch(() => ({}));
          ok = j && typeof j === 'object';
        }
        results.push([name, ok ? 'ok' : 'warn']);
      } catch {
        results.push([name, 'err']);
      }
    }

    const html = results.map(([k, s]) => {
      const cls = s === 'ok' ? 'ok' : s === 'warn' ? 'warn' : 'err';
      return `<span class="${cls}">${k}:${s}</span>`;
    }).join(' | ');

    el.innerHTML = `健康檢查 → ${html} &nbsp; <span class="ok">（就算 warn/err 也不會白畫面）</span>`;
  })();
  </script>
</body>
</html>
